!function(){"use strict";const t=document.body.hasAttribute("s-debug"),e=new WeakMap,n=new WeakSet,o=new WeakMap;function r(e){t&&console.warn("[silcrow]",e)}function s(e){if(t)throw new Error("[silcrow] "+e)}const i=/^\.?[A-Za-z0-9_-]+(\.[A-Za-z0-9_-]+)*$/;function c(t){return i.test(t)}function l(t){const e=t.getAttribute("s-bind");if(!e)return null;const n=e.indexOf(":");return{path:-1===n?e:e.substring(0,n),prop:-1===n?null:e.substring(n+1)}}function a(t){return t&&t.toLowerCase().startsWith("on")}const u={value:"string",checked:"boolean",disabled:"boolean",selected:"boolean",src:"string",href:"string",selectedIndex:"number"};function f(t,e,n){if(a(e))s("Binding to event handler attribute rejected: "+e);else if(null!==e)if(null!=n)e in u?t[e]=n:t.setAttribute(e,String(n));else if(e in u){const n=u[e];t[e]="boolean"!==n&&("number"===n?0:"")}else t.removeAttribute(e);else t.textContent=null==n?"":String(n)}function d(t,e){const n=l(t);if(!n)return;const{path:o,prop:i}=n;o&&!o.startsWith(".")&&(a(i)?s("Binding to event handler attribute rejected: "+i):c(o)?(e.has(o)||e.set(o,[]),e.get(o).push({el:t,prop:i})):r("Invalid path: "+o))}function p(t,e){n.has(t)||(!function(t){const e=t.content;e.querySelectorAll("script").length&&s("Script not allowed in template");for(const t of e.querySelectorAll("*")){for(const e of t.attributes)e.name.toLowerCase().startsWith("on")&&s("Event handler attribute not allowed in template");t.hasAttribute("s-list")&&s("Nested s-list not allowed")}}(t),n.add(t));const r=t.content.cloneNode(!0),i=[];for(const t of r.children)1===t.nodeType&&i.push(t);if(1!==i.length)return s("Template must contain exactly one element child"),document.createElement("div");const c=i[0],a=new Map;if(c.hasAttribute("s-bind")){const t=l(c);if(t?.path.startsWith(".")){const e=t.path.substring(1);a.has(e)||a.set(e,[]),a.get(e).push({el:c,prop:t.prop})}}for(const t of c.querySelectorAll("[s-bind]")){const e=l(t);if(e?.path.startsWith(".")){const n=e.path.substring(1);a.has(n)||a.set(n,[]),a.get(n).push({el:t,prop:e.prop})}}return o.set(c,a),function(t,e){const n=function(t){const e=[];t.hasAttribute&&t.hasAttribute("s-bind")&&e.push(t);const n=t.querySelectorAll("[s-bind]");for(const t of n)t.closest("template")||e.push(t);return e}(t);for(const t of n){const n=l(t);n&&(n.path.startsWith(".")||d(t,e))}}(c,e),c}function h(t,e){const n=t.getAttribute("s-template");return function(o){let r=null;if(o&&null!=o.key){const t=String(o.key),e=t.indexOf("#");if(-1!==e){const n=t.substring(0,e);r=document.getElementById(n)}}return!r&&n&&(r=document.getElementById(n)),r||(r=t.querySelector(":scope > template")),r?p(r,e):(s("No resolvable template for collection"),document.createElement("div"))}}function b(t,e,n){if(!function(t){for(let e=0;e<t.length;e++){const n=t[e];if(null==n||"object"!=typeof n||Array.isArray(n))return!1;if(!("key"in n))return!1}return!0}(e))return void r("Collection array contains invalid items, discarding");const o=new Map;for(const e of t.children)e.dataset&&e.hasAttribute("s-key")&&o.set(e.dataset.key,e);const s=[];for(const t of e)null!=t.key?s.push(t):r("Collection item missing key, skipping");const i=new Set;for(const t of s){const e=String(t.key);if(i.has(e))return void r("Duplicate key: "+e);i.add(e)}const c=new Set;let l=null;for(const e of s){const r=String(e.key);c.add(r);let s=o.get(r);s||(s=n(e),s.dataset.key=r,s.setAttribute("s-key","")),m(s,e),l?l.nextElementSibling!==s&&l.after(s):t.firstElementChild!==s&&t.prepend(s),l=s}for(const[t,e]of o)c.has(t)||e.remove()}function m(t,e){const n=o.get(t);if(n)for(const t in e){if("key"===t)continue;const o=n.get(t);if(o)for(const{el:n,prop:r}of o)f(n,r,e[t])}}function y(t,e){const n=e.split(".");let o=t;for(const t of n){if(null==o)return;if("__proto__"===t||"constructor"===t||"prototype"===t)return;o=o[t]}return o}function g(t){if("string"==typeof t){const e=document.querySelector(t);return e||(s("Root element not found: "+t),document.createElement("div"))}return t instanceof Element?t:(s("Invalid root: must be selector string or Element"),document.createElement("div"))}window.Silcrow={patch:function(n,o,i={}){const l=g(o);let a=e.get(l);a&&!i.invalidate||(a=function(t){const e=new Map,n=new Map,o=t.querySelectorAll("[s-bind]");for(const t of o)t.closest("template")||d(t,e);t.hasAttribute&&t.hasAttribute("s-bind")&&!t.closest("template")&&d(t,e);const r=t.querySelectorAll("[s-list]");for(const t of r){const o=t.getAttribute("s-list");c(o)?n.set(o,{container:t,resolveTemplate:h(t,e)}):s("Invalid collection name: "+o)}return{scalarMap:e,collectionMap:n}}(l),e.set(l,a)),function(e,n,o){for(const[t,o]of n.entries()){const n=y(e,t);if(void 0!==n)for(const{el:t,prop:e}of o)f(t,e,n)}for(const[n,{container:s,resolveTemplate:i}]of o.entries()){const o=y(e,n);Array.isArray(o)?b(s,o,i):void 0!==o&&t&&r("Collection value is not an array: "+n)}}(n,a.scalarMap,a.collectionMap),i.silent||l.dispatchEvent(new CustomEvent("silcrow:patched",{bubbles:!0,detail:{paths:Array.from(a.scalarMap.keys())}}))},invalidate:function(t){const o=g(t);e.delete(o);const r=o.querySelectorAll("template");for(const t of r)n.delete(t)},stream:function(t){const e=g(t);let n=null,o=!1;return function(t){n=t,o||(o=!0,queueMicrotask(()=>{o=!1,Silcrow.patch(n,e)}))}}}}();