<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Error Handling & Retry Logic - Silcrow</title>
  <style>
    * {margin: 0; padding: 0; box-sizing: border-box;}

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      padding: 40px 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: linear-gradient(45deg, #ff6b6b, #ee5a6f);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .card {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 24px;
      border: 1px solid #3a3a3a;
    }

    .card h2 {
      margin-bottom: 20px;
      color: #ffffff;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 30px;
    }

    button {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-success {
      background: #22c55e;
      color: white;
    }

    .btn-primary:hover {background: #2563eb;}
    .btn-danger:hover {background: #dc2626;}
    .btn-success:hover {background: #16a34a;}

    .log-container {
      background: #1a1a1a;
      border: 1px solid #3a3a3a;
      border-radius: 8px;
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
    }

    .log-entry {
      padding: 8px 0;
      border-bottom: 1px solid #2a2a2a;
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-time {
      color: #888;
      margin-right: 12px;
    }

    .log-success {color: #22c55e;}
    .log-error {color: #ef4444;}
    .log-warning {color: #f59e0b;}
    .log-info {color: #3b82f6;}

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: #1a1a1a;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .status-item {
      text-align: center;
    }

    .status-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .status-label {
      font-size: 0.85rem;
      color: #888;
      text-transform: uppercase;
    }

    .data-section {
      background: #1a1a1a;
      padding: 20px;
      border-radius: 8px;
    }

    .data-list {
      list-style: none;
    }

    .data-item {
      padding: 12px;
      background: #2a2a2a;
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #444;
      border-top: 2px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {transform: rotate(0deg);}
      100% {transform: rotate(360deg);}
    }
  </style>
</head>
<body s-debug>
  <div class="container">
    <div class="header">
      <h1>üõ°Ô∏è Production Error Handling</h1>
      <p>Retry logic, exponential backoff, and graceful degradation</p>
    </div>

    <div class="card">
      <h2>Status & Metrics</h2>
      <div class="status-bar">
        <div class="status-item">
          <div class="status-value" s-bind="metrics.totalRequests">0</div>
          <div class="status-label">Total Requests</div>
        </div>
        <div class="status-item">
          <div class="status-value log-success" s-bind="metrics.successful">0</div>
          <div class="status-label">Successful</div>
        </div>
        <div class="status-item">
          <div class="status-value log-error" s-bind="metrics.failed">0</div>
          <div class="status-label">Failed</div>
        </div>
        <div class="status-item">
          <div class="status-value log-warning" s-bind="metrics.retries">0</div>
          <div class="status-label">Retries</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Test Controls</h2>
      <div class="controls">
        <button class="btn-success" onclick="fetchWithRetry(false)">
          ‚úÖ Successful Request
        </button>
        <button class="btn-danger" onclick="fetchWithRetry(true)">
          ‚ùå Force Failure
        </button>
        <button class="btn-primary" onclick="fetchWithRetry('intermittent')">
          ‚ö†Ô∏è Intermittent Failure
        </button>
        <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
      </div>
    </div>

    <div class="card">
      <h2>Fetched Data</h2>
      <div class="data-section">
        <ul class="data-list" s-list="items">
          <template>
            <li class="data-item">
              <span s-bind=".title"></span>
              <span s-bind=".status"></span>
            </li>
          </template>
        </ul>
        <div id="emptyState" style="text-align: center; padding: 40px; color: #666;">
          No data loaded yet. Try a request above.
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Request Log</h2>
      <div class="log-container" id="logContainer"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/gh/jeetkhinde/silcrow@1.0.0/silcrow.runtime.js"></script>

  <script>
    let state = {
      metrics: {
        totalRequests: 0,
        successful: 0,
        failed: 0,
        retries: 0
      },
      items: []
    };

    function render() {
      Silcrow.patch(state, 'body');
      document.getElementById('emptyState').style.display =
        state.items.length === 0 ? 'block' : 'none';
    }

    // Production-ready retry logic with exponential backoff
    async function fetchWithRetry(shouldFail, maxRetries = 3) {
      const startTime = Date.now();
      state.metrics.totalRequests++;

      for (let attempt = 0; attempt <= maxRetries; attempt++) {
        try {
          log(`Attempt ${attempt + 1}/${maxRetries + 1}...`, 'info');

          // Simulate API call
          const data = await mockApiCall(shouldFail, attempt);

          // Success!
          state.metrics.successful++;
          state.items = data.map((item, i) => ({
            key: Date.now() + i,
            title: item,
            status: '‚úÖ'
          }));

          const duration = Date.now() - startTime;
          log(`Success after ${duration}ms (${attempt} retries)`, 'success');

          render();
          return data;

        } catch (error) {
          state.metrics.retries++;

          if (attempt < maxRetries) {
            // Exponential backoff: 1s, 2s, 4s
            const delay = Math.pow(2, attempt) * 1000;
            log(`Failed. Retrying in ${delay}ms... (${error.message})`, 'warning');
            await sleep(delay);
          } else {
            // Max retries reached - graceful degradation
            state.metrics.failed++;
            log(`Failed after ${maxRetries + 1} attempts. Using cached/fallback data.`, 'error');

            // Load fallback data
            state.items = [
              { key: 1, title: 'Cached Item 1 (Fallback)', status: '‚ö†Ô∏è' },
              { key: 2, title: 'Cached Item 2 (Fallback)', status: '‚ö†Ô∏è' }
            ];

            render();
            throw error;
          }
        }
      }
    }

    // Mock API with configurable failure
    function mockApiCall(shouldFail, attempt) {
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          if (shouldFail === true) {
            reject(new Error('Network error'));
          } else if (shouldFail === 'intermittent' && attempt < 2) {
            reject(new Error('Temporary server error'));
          } else {
            resolve([
              'Product A - Available',
              'Product B - In Stock',
              'Product C - Low Stock',
              'Product D - Pre-order'
            ]);
          }
        }, 500);
      });
    }

    function log(message, type = 'info') {
      const container = document.getElementById('logContainer');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `
        <span class="log-time">${time}</span>
        <span class="log-${type}">${message}</span>
      `;
      container.insertBefore(entry, container.firstChild);

      // Keep only last 50 logs
      while (container.children.length > 50) {
        container.removeChild(container.lastChild);
      }

      render();
    }

    function clearLogs() {
      document.getElementById('logContainer').innerHTML = '';
      state.metrics = {
        totalRequests: 0,
        successful: 0,
        failed: 0,
        retries: 0
      };
      render();
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Initial render
    render();
    log('System ready. Try the controls above.', 'info');

    // Global error handler
    window.addEventListener('error', (event) => {
      log(`Uncaught error: ${event.message}`, 'error');
    });

    window.addEventListener('unhandledrejection', (event) => {
      log(`Unhandled promise rejection: ${event.reason}`, 'error');
    });
  </script>
</body>
</html>
